
@{
    ViewBag.Title = "Project List";
}

<h2 id="project-list-label">@Resource.ProjectList.ProjectListRe.ProjectList_Label</h2>
<form id="search-form" action="/Project/SearchProject">
    <input id="search-input" type="text" class="form-control"
           name="SearchTerm" placeholder="@Resource.ProjectList.ProjectListRe.CategoryFilterHolder_Label"
           value="@Session["SearchTerm"]">
    @*<select id="status-search-input" class="form-control" name="Status">
            <option value="ALL">@Resource.ProjectList.ProjectListRe.ProjectStatusHolder_Label</option>
            <option value="NEW">@Resource.ProjectList.ProjectListRe.ProjectStatusNew_Label</option>
            <option value="PLA">@Resource.ProjectList.ProjectListRe.ProjectStatusPlanned_Label</option>
            <option value="INP">@Resource.ProjectList.ProjectListRe.ProjectStatusInProgress_Label</option>
            <option value="FIN">@Resource.ProjectList.ProjectListRe.ProjectStatusFinished_Label</option>
        </select>*@
    @{
        List<SelectListItem> statusList = new List<SelectListItem>();
        statusList.Add(new SelectListItem
        {
            Text = @Resource.ProjectList.ProjectListRe.ProjectStatusNew_Label,
            Value = "NEW",
            Selected = Session["SearchStatus"]?.ToString() == "NEW"
        });
        statusList.Add(new SelectListItem
        {
            Text = @Resource.ProjectList.ProjectListRe.ProjectStatusPlanned_Label,
            Value = "PLA",
            Selected = Session["SearchStatus"]?.ToString() == "PLA"
        });
        statusList.Add(new SelectListItem
        {
            Text = @Resource.ProjectList.ProjectListRe.ProjectStatusInProgress_Label,
            Value = "INP",
            Selected = Session["SearchStatus"]?.ToString() == "INP"
        });
        statusList.Add(new SelectListItem
        {
            Text = @Resource.ProjectList.ProjectListRe.ProjectStatusFinished_Label,
            Value = "FIN",
            Selected = Session["SearchStatus"]?.ToString() == "FIN"
        });
    }
    @Html.DropDownList("SearchStatus", statusList, @Resource.ProjectList.ProjectListRe.ProjectStatusHolder_Label, new { @class = "form-control", id = "status-search-input" })
    <input id="submit-button" class="btn btn-primary" type="submit" value="@Resource.ProjectList.ProjectListRe.Search_Label" />
    <button type="button" id="reset-button"><a href="/Project/SearchProject">@Resource.ProjectList.ProjectListRe.ResetSearch_Label </a></button>
</form>
<div><span class="label @(ViewBag.ProjectList.Count==0? "label-danger" : "label-success")">@Resource.ProjectList.ProjectListRe.ProjectsFoundLabel @ViewBag.ProjectList.Count</span></div>
@*Data table*@
<div class="wrap-table100">
    <div class="table100" style="width:70vw;">
        <table style="width:70vw;">
            <thead>
                <tr class="table100-head">
                    <th style="width:3vw;">...</th>
                    <th style="width:6vw;">@Resource.ProjectList.ProjectListRe.ProjectNumber_Header</th>
                    <th>@Resource.ProjectList.ProjectListRe.Name_Header</th>
                    <th style="width:8vw;">@Resource.ProjectList.ProjectListRe.Status_Header</th>
                    <th style="width:10vw;">@Resource.ProjectList.ProjectListRe.Customer_Header</th>
                    <th style="width:8vw;">@Resource.ProjectList.ProjectListRe.StartDate_Header</th>
                    <th style="width:6vw; text-align:center;">@Resource.ProjectList.ProjectListRe.Delete_Header</th>
                </tr>
            </thead>
            <tbody>
                @Html.AntiForgeryToken()
                @foreach (var item in ViewBag.ProjectList)
                {

                }
                @foreach (var x in ViewBag.ProjectList)
                {
                    <tr>
                        <td><input type="checkbox" @(x.Status != "NEW" ? "disabled" : "") onchange='handleChange(this,@x.ID,@x.Version)'></td>
                        <td><a href="/Project/EditProject/@x.ID">@x.ProjectNumber</a></td>
                        <td>@x.Name</td>
                        <td>
                            @switch (x.Status)
                            {
                                case "NEW":
                                    @Resource.ProjectList.ProjectListRe.ProjectStatusNew_Label;
                                    break;
                                case "PLA":
                                    @Resource.ProjectList.ProjectListRe.ProjectStatusPlanned_Label;
                                    break;
                                case "INP":
                                    @Resource.ProjectList.ProjectListRe.ProjectStatusInProgress_Label;
                                    break;
                                case "FIN":
                                    @Resource.ProjectList.ProjectListRe.ProjectStatusFinished_Label;
                                    break;
                            }
                        </td>




                        <td>@x.Customer</td>
                        <td>@Convert.ToDateTime(x.StartDate).ToString("dd/MM/yyyy")</td>
                        <td style="text-align:center;" @(x.Status == "NEW" ? $"onclick=onDeleteProject({x.ID},{x.Version}) " : "" )>
                            @if (x.Status == "NEW")
                            {
                                //style="font-size: 20px; font-weight: bold; color: rgb(255, 89, 89);
                                <i class="fa fa-trash-o delete-icon"></i>
                            }
                        </td>
                        
                    </tr>
                }

            </tbody>

        </table>
        <div id="item-count-tr" data-toggle="modal" data-target="#confirmMultpleDeleteModal">
            <div id="num-item-selected-text">
                <p><span id="item-count">0</span>  @Resource.ProjectList.ProjectListRe.ItemSelected_Label</p>
            </div>
            <div id="delete-selected-button">
                <span id="item-count-text">
                    <i class="fa fa-trash-o delete-icon"></i> @Resource.ProjectList.ProjectListRe.DeleteSelectedItems_Label
                </span>
            </div>

        </div>

    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel">@Resource.ProjectList.ProjectListRe.Confirm_WordLabel</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="confirm-warning">
                    <p style="font-size:14px;">@Resource.ProjectList.ProjectListRe.ConfirmDelete_Warning</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-dismiss="modal">@Resource.ProjectList.ProjectListRe.Close_WordLabel</button>
                <button type="button" class="btn btn-danger" onclick="obSubmitDeleteProject()">@Resource.ProjectList.ProjectListRe.Delete_WordLabel</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmMultpleDeleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel">@Resource.ProjectList.ProjectListRe.Confirm_WordLabel</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="confirm-warning">
                    <p style="font-size:14px;">@Resource.ProjectList.ProjectListRe.ConfirmMultipleDelete_Warning</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-dismiss="modal">@Resource.ProjectList.ProjectListRe.Close_WordLabel</button>
                <button type="button" class="btn btn-primary" onclick="onSubmitDeleteMultiple()">@Resource.ProjectList.ProjectListRe.Delete_WordLabel</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="delete-error-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel">Error</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="delete-error-warning">
                    <p style="font-size:14px;" id="delete-error-warning-text"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-dismiss="modal">@Resource.ProjectList.ProjectListRe.Close_WordLabel</button>
                <button type="button" class="btn btn-danger" onclick="onCloseErrorWarningModal()">Refresh</button>
            </div>
        </div>
    </div>
</div>
<script>

    @*var visaSelect = new SlimSelect({
        select: '#slim-select'
    })*@

    //------------------
    var currentProjectSelectedForDeleteID;
    var deleteList = [];
    var itemcount = 0;
    function onCloseErrorWarningModal() {
        window.location.href = '/Project/ProjectList';
        $('#delete-error-modal').modal('hide');
    }
    function handleResponseDelete() {

        if (this.readyState == 4 && this.status == 200) {
            let responseObject = JSON.parse(this.responseText);
            if (responseObject.hasError == true) {
                //modal hiện error message!
                console.log(responseObject.errMessage);
                document.getElementById("delete-error-warning-text").innerHTML = responseObject.errMessage;
                $('#delete-error-modal').modal('show');
            } else if (responseObject.hasError == false) {
                $('#confirmMultipleDeleteModal').modal('hide');
                window.location.href = '/Project/ProjectList';
            }
        } else if (this.readyState == 4 && this.status == 500) {
            window.location.href = '/Home/NotFound';
        }
    }
    function obSubmitDeleteProject() {

        let xhttp = new XMLHttpRequest();
        let JSONObject = [currentProjectSelectedForDeleteID];
        xhttp.open("POST", "/Project/DeleteProject", true);
        xhttp.onreadystatechange = handleResponseDelete;

        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.setRequestHeader("Accept", "application/json");
        xhttp.send(JSON.stringify(JSONObject));
        $('#confirmDeleteModal').modal('hide');

    }
    function onDeleteProject(_id,_version) {
        $('#confirmDeleteModal').modal('show');
        currentProjectSelectedForDeleteID = { ID : _id, Version : _version } ;
    }

    function handleChange(checkbox, id, version) {
        const projectObj = { ID: id, Version: version };
        if (checkbox.checked == true) {
            deleteList.push(projectObj);
            itemcount++;
            document.getElementById("item-count").innerHTML = itemcount;
            document.getElementById("delete-selected-button").style.visibility = "visible";

        } else {
            let index = deleteList.findIndex(proj => proj.ID === id);
            if (index > -1) {
                deleteList.splice(index, 1);
            }
            itemcount--;
            document.getElementById("item-count").innerHTML = itemcount;
            if (itemcount == 0) {
                document.getElementById("delete-selected-button").style.visibility = "hidden";
            }

        }
    }

    function onSubmitDeleteMultiple() {
        if (itemcount > 0) {
            let xhttp = new XMLHttpRequest();
            let JSONObject = [...deleteList];
            xhttp.open("POST", "/Project/DeleteProject", true);
            xhttp.onreadystatechange = handleResponseDelete;
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.setRequestHeader("Accept", "application/json");
            xhttp.send(JSON.stringify(JSONObject));
        }
        $('#confirmDeleteModal').modal('hide');
    }
</script>